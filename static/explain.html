<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Debug SHAP Forwarding</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen text-center">
  <div class="bg-white shadow-md rounded-lg p-6 max-w-xl w-full">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ§ª SHAP â†’ Chat Test</h2>
    <p class="text-gray-600 mb-2">Testing /explain â†’ /chat â†’ Frontend</p>

    <div id="loading" class="text-blue-600 font-medium mt-4">â³ Loading explanation...</div>
    <div id="explanation-container" class="hidden mt-6 text-left text-gray-700 text-sm whitespace-pre-wrap bg-gray-50 p-4 rounded shadow">
      <p class="font-semibold text-gray-800 mb-2" id="throughput-mbps"></p>
      <ul id="feature-list" class="list-disc list-inside"></ul>
    </div>
  </div>

  <script>
    async function fetchExplanationViaChat() {
  const inputDataStr = localStorage.getItem("lastInputData");
  if (!inputDataStr) {
    document.getElementById("loading").innerText = "âš ï¸ No input data found.";
    return;
  }

  try {
    const inputData = JSON.parse(inputDataStr);

    // Step 1: Get SHAP from /explain
    const explainRes = await fetch("/explain", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(inputData)
    });

    if (!explainRes.ok) throw new Error("Failed to fetch SHAP from /explain.");
    const explainData = await explainRes.json();

    // Step 2: Send SHAP to /chat
    const chatRes = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        throughput_mbps: explainData.throughput_mbps,
        explanation: explainData.explanation,
        features: explainData.features
      })
    });

    if (!chatRes.ok) throw new Error("Failed to forward to /chat.");
    const chatData = await chatRes.json();

    // Step 3: Display the prompt preview
    document.getElementById("throughput-mbps").innerText =
      "ğŸ“‹ Prompt Sent to ChatGPT (Preview):";

    const list = document.getElementById("feature-list");
    list.innerHTML = "";

    const promptLines = chatData.prompt_preview.split("\n");
    promptLines.forEach(line => {
      const li = document.createElement("li");
      li.innerText = line;
      list.appendChild(li);
    });

    document.getElementById("loading").classList.add("hidden");
    document.getElementById("explanation-container").classList.remove("hidden");

  } catch (err) {
    document.getElementById("loading").innerText = "âš ï¸ Error fetching data.";
    console.error(err);
  }
}
window.onload = fetchExplanationViaChat;

  </script>
</body>
</html>
